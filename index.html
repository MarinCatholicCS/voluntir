<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Voluntir ‚Äî Volunteer Coordination Platform</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Asap:wght@300;400;500;600;700&family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,400;0,9..144,500;0,9..144,600;0,9..144,700;0,9..144,800;0,9..144,900&display=swap" rel="stylesheet" />
  <link rel="icon" type="image/x-icon" href="voluntir.ico" />
  <link rel="icon" type="image/png" href="voluntir.png" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Asap', sans-serif; background: #F8FBF6; color: #1A2E12; -webkit-font-smoothing: antialiased; }
    #root { min-height: 100vh; }
    #loading-screen {
      position: fixed; inset: 0; z-index: 9999; background: #F8FBF6;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      transition: opacity 0.3s ease;
    }
    #loading-screen.fade-out { opacity: 0; pointer-events: none; }
    #loading-screen .logo { width: 48px; height: 48px; border-radius: 14px; background: linear-gradient(135deg, #6BBF4E, #3A8F28); display: flex; align-items: center; justify-content: center; margin-bottom: 16px; }
    #loading-screen .logo svg { color: #fff; }
    #loading-screen h1 { font-family: 'Fraunces', serif; font-weight: 800; font-size: 28px; color: #1A2E12; letter-spacing: -0.02em; margin-bottom: 8px; }
    #loading-screen p { color: #8BA67D; font-size: 14px; font-family: 'Asap', sans-serif; }
    @keyframes pulse { 0%,100% { opacity:.5; } 50% { opacity:1; } }
    #loading-screen .dots { animation: pulse 1.5s infinite; }
  </style>
</head>
<body>
  <div id="loading-screen">
    <div class="logo">
      <img src="voluntir.png" alt="Voluntir" width="32" height="32" style="border-radius:4px;" onerror="this.style.display='none';this.parentElement.innerHTML='<svg width=24 height=24 viewBox=&quot;0 0 24 24&quot; fill=none stroke=white stroke-width=2 stroke-linecap=round stroke-linejoin=round><path d=&quot;M11 20A7 7 0 0 1 9.8 6.9C15.5 4.9 17 3.5 19 2c1 2 2 4.5 2 8 0 5.5-4.78 10-10 10Z&quot;/><path d=&quot;M2 21c0-3 1.85-5.36 5.08-6C9.5 14.52 12 13 13 12&quot;/></svg>'"/>
    </div>
    <h1>Voluntir</h1>
    <p class="dots">Loading application...</p>
  </div>
  <div id="root"></div>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel" data-type="module">
const { useState, useEffect, useRef } = React;

const FIREBASE_CONFIG = {
  apiKey: "AIzaSyBdSG6aWFGz-ZqgFUp7R1KjKPAxX73XZEg",
  authDomain: "voluntir-38c1c.firebaseapp.com",
  databaseURL: "https://voluntir-38c1c-default-rtdb.firebaseio.com",
  projectId: "voluntir-38c1c",
  storageBucket: "voluntir-38c1c.firebasestorage.app",
  messagingSenderId: "341357751723",
  appId: "1:341357751723:web:9757e2bb80e20cea55f6ee"
};

let _app=null,_auth=null,_db=null,_fb={};
async function loadFirebase() {
  if (_app) return {auth:_auth,db:_db,..._fb};
  const [am,au,fi] = await Promise.all([
    import("https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"),
    import("https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"),
    import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"),
  ]);
  _app=am.initializeApp(FIREBASE_CONFIG);
  _auth=au.getAuth(_app);
  _db=fi.getFirestore(_app);
  _fb={
    GoogleAuthProvider:au.GoogleAuthProvider,signInWithPopup:au.signInWithPopup,
    signOut:au.signOut,onAuthStateChanged:au.onAuthStateChanged,
    collection:fi.collection,doc:fi.doc,getDoc:fi.getDoc,getDocs:fi.getDocs,
    setDoc:fi.setDoc,addDoc:fi.addDoc,deleteDoc:fi.deleteDoc,
    query:fi.query,orderBy:fi.orderBy,arrayUnion:fi.arrayUnion,
    arrayRemove:fi.arrayRemove,increment:fi.increment,serverTimestamp:fi.serverTimestamp,
  };
  return {auth:_auth,db:_db,..._fb};
}

const C={
  white:"#FFFFFF",offWhite:"#F8FBF6",cream:"#F1F7EC",
  greenLight:"#E2F0D5",greenMid:"#A8D88C",greenAccent:"#6BBF4E",
  greenDark:"#3A8F28",greenDeep:"#2D6E1F",
  textPrimary:"#1A2E12",textSecondary:"#5A7A4C",textMuted:"#8BA67D",
  border:"#D4E8C8",borderLight:"#E8F2E0",
  shadow:"rgba(58,143,40,0.08)",shadowMd:"rgba(58,143,40,0.12)",
  red:"#E53E3E",redLight:"#FFF5F5",
};

// Today's date string in YYYY-MM-DD for filtering/validation
function getTodayStr() {
  const d = new Date();
  return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');
}

function genTimeOptions(){
  const opts=[];
  for(let h=6;h<=22;h++){
    for(let m=0;m<60;m+=15){
      const ap=h<12?"AM":"PM";
      const h12=h===0?12:h>12?h-12:h;
      opts.push({label:`${h12}:${String(m).padStart(2,"0")} ${ap}`,value:`${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`});
    }
  }
  return opts;
}
const TIME_OPTIONS=genTimeOptions();

function toMins(v){const[h,m]=v.split(":").map(Number);return h*60+m;}
function toLabel(v){if(!v)return"";const o=TIME_OPTIONS.find(x=>x.value===v);return o?o.label:v;}
function calcHours(s,e){if(!s||!e)return 0;return Math.max(0,Math.round((toMins(e)-toMins(s))/60*10)/10);}
function buildTimeStr(s,e){if(!s||!e)return"";return`${toLabel(s)} ‚Äì ${toLabel(e)}`;}
function parseHours(t){
  if(!t)return 2;
  const m=t.match(/(\d+):(\d+)\s*(AM|PM)\s*[‚Äì-]\s*(\d+):(\d+)\s*(AM|PM)/i);
  if(!m)return 2;
  let sh=+m[1],sm=+m[2],sp=m[3].toUpperCase(),eh=+m[4],em=+m[5],ep=m[6].toUpperCase();
  if(sp==="PM"&&sh!==12)sh+=12;if(sp==="AM"&&sh===12)sh=0;
  if(ep==="PM"&&eh!==12)eh+=12;if(ep==="AM"&&eh===12)eh=0;
  return Math.max(1,Math.round((eh*60+em-(sh*60+sm))/60));
}

// useIsMobile hook
function useIsMobile() {
  const [isMobile, setIsMobile] = useState(window.innerWidth <= 768);
  useEffect(() => {
    const handler = () => setIsMobile(window.innerWidth <= 768);
    window.addEventListener('resize', handler);
    return () => window.removeEventListener('resize', handler);
  }, []);
  return isMobile;
}

async function fbSignIn(){const fb=await loadFirebase();return fb.signInWithPopup(fb.auth,new fb.GoogleAuthProvider());}
async function fbSignOut(){const fb=await loadFirebase();return fb.signOut(fb.auth);}
async function fbGetProfile(uid){const fb=await loadFirebase();const s=await fb.getDoc(fb.doc(fb.db,"users",uid));return s.exists()?s.data():null;}
async function fbSetProfile(uid,data){const fb=await loadFirebase();await fb.setDoc(fb.doc(fb.db,"users",uid),data,{merge:true});}
async function fbGetListings(){const fb=await loadFirebase();const q=fb.query(fb.collection(fb.db,"listings"),fb.orderBy("date","asc"));const s=await fb.getDocs(q);return s.docs.map(d=>({id:d.id,...d.data()}));}
async function fbAddListing(data){const fb=await loadFirebase();const r=await fb.addDoc(fb.collection(fb.db,"listings"),{...data,createdAt:fb.serverTimestamp()});return r.id;}
async function fbDeleteListing(id){const fb=await loadFirebase();await fb.deleteDoc(fb.doc(fb.db,"listings",id));}
async function fbSignUp(lid,uid,hours){const fb=await loadFirebase();await fb.setDoc(fb.doc(fb.db,"listings",lid),{volunteers:fb.arrayUnion(uid),currentVolunteers:fb.increment(1)},{merge:true});await fb.setDoc(fb.doc(fb.db,"users",uid),{hoursServed:fb.increment(hours)},{merge:true});}
async function fbUnsign(lid,uid,hours){const fb=await loadFirebase();await fb.setDoc(fb.doc(fb.db,"listings",lid),{volunteers:fb.arrayRemove(uid),currentVolunteers:fb.increment(-1)},{merge:true});const s=await fb.getDoc(fb.doc(fb.db,"users",uid));const cur=s.exists()?(s.data().hoursServed||0):0;await fb.setDoc(fb.doc(fb.db,"users",uid),{hoursServed:Math.max(0,cur-hours)},{merge:true});}
async function fbGetLeaderboard(){const fb=await loadFirebase();const q=fb.query(fb.collection(fb.db,"users"),fb.orderBy("hoursServed","desc"));const s=await fb.getDocs(q);return s.docs.map(d=>({uid:d.id,...d.data()}));}
async function fbGetUsersByIds(uids){if(!uids||uids.length===0)return[];const fb=await loadFirebase();const results=await Promise.all(uids.map(async uid=>{try{const s=await fb.getDoc(fb.doc(fb.db,"users",uid));return s.exists()?{uid,...s.data()}:null;}catch(e){return null;}}));return results.filter(Boolean);}
async function fbDeductHoursFromUsers(uids,hours){if(!uids||uids.length===0)return;const fb=await loadFirebase();await Promise.all(uids.map(async uid=>{try{const s=await fb.getDoc(fb.doc(fb.db,"users",uid));const cur=s.exists()?(s.data().hoursServed||0):0;await fb.setDoc(fb.doc(fb.db,"users",uid),{hoursServed:Math.max(0,cur-hours)},{merge:true});}catch(e){console.error("deduct error",uid,e);}}));}

function formatDate(s){if(!s)return"";return new Date(s+"T00:00:00").toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric",year:"numeric"});}
function getInitials(n){if(!n)return"??";return n.split(" ").map(w=>w[0]).join("").toUpperCase().slice(0,2);}

function ProgressBar({current,total}){
  const pct=Math.min((current/total)*100,100);
  return <div style={{width:"100%",height:6,borderRadius:3,background:C.borderLight,overflow:"hidden"}}><div style={{width:`${pct}%`,height:"100%",borderRadius:3,background:`linear-gradient(90deg,${C.greenAccent},${C.greenMid})`,transition:"width 0.6s cubic-bezier(0.4,0,0.2,1)"}}/></div>;
}

function Avatar({name,size=40,rank,photoURL,profilePic}){
  const ini=getInitials(name);
  const cols=[{bg:C.greenLight,text:C.greenDark},{bg:"#FFF3E0",text:"#E65100"},{bg:"#E3F2FD",text:"#1565C0"},{bg:"#FCE4EC",text:"#AD1457"},{bg:"#F3E5F5",text:"#6A1B9A"}];
  const c=cols[(ini.charCodeAt(0)+(ini.length>1?ini.charCodeAt(1):0))%cols.length];
  const top3=rank!==undefined&&rank<3;
  const imgSrc=profilePic||photoURL;
  return <div style={{position:"relative",width:size,height:size,flexShrink:0}}>
    {imgSrc?<img src={imgSrc} alt={name} style={{width:size,height:size,borderRadius:"50%",objectFit:"cover",border:top3?`2px solid ${C.greenAccent}`:"none"}}/>
    :<div style={{width:size,height:size,borderRadius:"50%",background:c.bg,color:c.text,display:"flex",alignItems:"center",justifyContent:"center",fontWeight:700,fontSize:size*0.36,border:top3?`2px solid ${C.greenAccent}`:"none"}}>{ini}</div>}
  </div>;
}

function ConfirmModal({title,message,onConfirm,onCancel}){
  return <div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.5)",zIndex:500,display:"flex",alignItems:"center",justifyContent:"center",padding:24}}>
    <div style={{background:C.white,borderRadius:20,padding:"32px 28px",maxWidth:400,width:"100%",boxShadow:"0 20px 60px rgba(0,0,0,0.2)"}}>
      <div style={{fontSize:40,textAlign:"center",marginBottom:12}}>üóëÔ∏è</div>
      <h2 style={{fontFamily:"'Fraunces',serif",fontWeight:800,fontSize:22,color:C.textPrimary,margin:"0 0 10px 0",textAlign:"center"}}>{title}</h2>
      <p style={{fontSize:14,color:C.textSecondary,lineHeight:1.6,margin:"0 0 24px 0",textAlign:"center"}}>{message}</p>
      <div style={{display:"flex",gap:10}}>
        <button onClick={onCancel} style={{flex:1,padding:"11px 0",borderRadius:10,border:`1.5px solid ${C.border}`,background:"transparent",fontWeight:600,fontSize:14,color:C.textSecondary,cursor:"pointer"}}>Cancel</button>
        <button onClick={onConfirm} style={{flex:1,padding:"11px 0",borderRadius:10,border:"none",background:C.red,fontWeight:700,fontSize:14,color:"#fff",cursor:"pointer"}}>Delete</button>
      </div>
    </div>
  </div>;
}

const I={
  Calendar:()=><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>,
  Clock:()=><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
  MapPin:()=><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>,
  Mail:()=><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>,
  Link:()=><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>,
  Trophy:()=><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>,
  Plus:()=><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
  User:()=><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
  Check:()=><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>,
  ArrowRight:()=><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>,
  Leaf:()=><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 20A7 7 0 0 1 9.8 6.9C15.5 4.9 17 3.5 19 2c1 2 2 4.5 2 8 0 5.5-4.78 10-10 10Z"/><path d="M2 21c0-3 1.85-5.36 5.08-6C9.5 14.52 12 13 13 12"/></svg>,
  Google:()=><svg width="18" height="18" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>,
  Logout:()=><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>,
  X:()=><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
  Trash:()=><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg>,
  Refresh:()=><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>,
  List:()=><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>,
  Camera:()=><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>,
  School:()=><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c0 1.1 2.7 3 6 3s6-1.9 6-3v-5"/></svg>,
  Menu:()=><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>,
};

function TimePicker({startVal,endVal,onStartChange,onEndChange}){
  const sel={padding:"10px 14px",borderRadius:10,border:`1.5px solid ${C.border}`,background:C.white,fontSize:14,color:C.textPrimary,outline:"none",cursor:"pointer",appearance:"none",WebkitAppearance:"none",width:"100%",backgroundImage:`url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%238BA67D' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E")`,backgroundRepeat:"no-repeat",backgroundPosition:"right 12px center",paddingRight:36};
  const hours=calcHours(startVal,endVal);
  return <div>
    <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10}}>
      <div>
        <label style={{fontSize:12,fontWeight:600,color:C.textMuted,display:"block",marginBottom:5,letterSpacing:"0.03em"}}>START TIME</label>
        <select style={sel} value={startVal} onChange={e=>onStartChange(e.target.value)} onFocus={e=>e.target.style.borderColor=C.greenAccent} onBlur={e=>e.target.style.borderColor=C.border}>
          <option value="">Select start‚Ä¶</option>
          {TIME_OPTIONS.map(o=><option key={o.value} value={o.value}>{o.label}</option>)}
        </select>
      </div>
      <div>
        <label style={{fontSize:12,fontWeight:600,color:C.textMuted,display:"block",marginBottom:5,letterSpacing:"0.03em"}}>END TIME</label>
        <select style={sel} value={endVal} onChange={e=>onEndChange(e.target.value)} onFocus={e=>e.target.style.borderColor=C.greenAccent} onBlur={e=>e.target.style.borderColor=C.border}>
          <option value="">Select end‚Ä¶</option>
          {TIME_OPTIONS.filter(o=>!startVal||toMins(o.value)>toMins(startVal)).map(o=><option key={o.value} value={o.value}>{o.label}</option>)}
        </select>
      </div>
    </div>
    {startVal&&endVal&&(
      <div style={{marginTop:8,padding:"8px 12px",borderRadius:8,background:C.greenLight,display:"inline-flex",alignItems:"center",gap:6}}>
        <I.Clock/>
        <span style={{fontSize:13,fontWeight:600,color:C.greenDark}}>{hours} hour{hours!==1?"s":""} ¬∑ {toLabel(startVal)} ‚Äì {toLabel(endVal)}</span>
      </div>
    )}
  </div>;
}

function btnStyle(variant="primary",extra={}){
  const base={display:"flex",alignItems:"center",justifyContent:"center",gap:6,padding:"10px 16px",borderRadius:10,fontWeight:600,fontSize:14,cursor:"pointer",transition:"all 0.2s",...extra};
  if(variant==="primary") return {...base,border:"none",background:`linear-gradient(135deg,${C.greenAccent},${C.greenDark})`,color:"#fff"};
  if(variant==="ghost") return {...base,border:`1.5px solid ${C.border}`,background:"transparent",color:C.textMuted};
  if(variant==="danger") return {...base,border:`1.5px solid ${C.border}`,background:"transparent",color:C.textMuted};
  return base;
}

function EventCard({listing,signedUp,isOwner,onSignUp,onUnsign,onView,onDelete}){
  const spots=listing.volunteersNeeded-listing.currentVolunteers;
  const full=spots<=0;
  return <div onClick={onView}
    style={{background:C.white,borderRadius:16,border:`1px solid ${C.borderLight}`,padding:20,cursor:"pointer",transition:"all 0.25s cubic-bezier(0.4,0,0.2,1)",boxShadow:`0 1px 3px ${C.shadow}`,position:"relative"}}
    onMouseEnter={e=>{e.currentTarget.style.transform="translateY(-2px)";e.currentTarget.style.boxShadow=`0 8px 24px ${C.shadowMd}`;e.currentTarget.style.borderColor=C.greenMid;}}
    onMouseLeave={e=>{e.currentTarget.style.transform="translateY(0)";e.currentTarget.style.boxShadow=`0 1px 3px ${C.shadow}`;e.currentTarget.style.borderColor=C.borderLight;}}>
    <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:10}}>
      <span style={{fontSize:11,fontWeight:600,color:C.greenAccent,letterSpacing:"0.06em",textTransform:"uppercase",flex:1,paddingRight:8}}>{listing.organizer}</span>
      <div style={{display:"flex",gap:4,alignItems:"center",flexShrink:0}}>
        {isOwner&&<span style={{background:C.cream,color:C.textSecondary,borderRadius:6,padding:"2px 6px",fontSize:10,fontWeight:600,whiteSpace:"nowrap"}}>Your Listing</span>}
        {signedUp&&<span style={{background:C.greenAccent,color:"#fff",borderRadius:6,padding:"2px 6px",fontSize:10,fontWeight:700,display:"flex",alignItems:"center",gap:2}}><I.Check/>Signed Up</span>}
      </div>
    </div>
    <h3 style={{fontFamily:"'Fraunces',serif",fontWeight:700,fontSize:18,color:C.textPrimary,margin:"0 0 6px 0",lineHeight:1.3}}>{listing.title}</h3>
    <p style={{fontSize:13,color:C.textSecondary,lineHeight:1.5,margin:"0 0 12px 0",display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical",overflow:"hidden"}}>{listing.description}</p>
    <div style={{display:"flex",flexDirection:"column",gap:5,marginBottom:12}}>
      {[{icon:<I.Calendar/>,text:formatDate(listing.date)},{icon:<I.Clock/>,text:listing.time},{icon:<I.MapPin/>,text:listing.location}].map((x,i)=>(
        <div key={i} style={{display:"flex",alignItems:"center",gap:7,color:C.textMuted,fontSize:12}}>{x.icon}<span style={{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{x.text}</span></div>
      ))}
    </div>
    <div style={{marginBottom:12}}>
      <div style={{display:"flex",justifyContent:"space-between",marginBottom:5}}>
        <span style={{fontSize:12,color:C.textSecondary,fontWeight:500}}><span style={{fontWeight:700,color:C.greenDark}}>{listing.currentVolunteers}</span> / {listing.volunteersNeeded} volunteers</span>
        <span style={{fontSize:11,color:full?C.textMuted:C.greenAccent,fontWeight:600}}>{full?"Full":`${spots} left`}</span>
      </div>
      <ProgressBar current={listing.currentVolunteers} total={listing.volunteersNeeded}/>
    </div>
    <div style={{display:"flex",gap:7}}>
      {signedUp?(
        <>
          <div style={{flex:1,padding:"9px 12px",borderRadius:10,background:C.greenLight,color:C.greenDark,fontWeight:600,fontSize:13,display:"flex",alignItems:"center",justifyContent:"center",gap:5}}><I.Check/>Registered</div>
          <button onClick={e=>{e.stopPropagation();onUnsign(listing.id);}}
            style={btnStyle("danger",{padding:"9px 12px",fontSize:13})}
            onMouseEnter={e=>{e.currentTarget.style.borderColor=C.red;e.currentTarget.style.color=C.red;e.currentTarget.style.background=C.redLight;}}
            onMouseLeave={e=>{e.currentTarget.style.borderColor=C.border;e.currentTarget.style.color=C.textMuted;e.currentTarget.style.background="transparent";}}><I.X/>Cancel</button>
        </>
      ):(
        <button onClick={e=>{e.stopPropagation();if(!full)onSignUp(listing.id);}} disabled={full}
          style={{flex:1,padding:"9px 12px",borderRadius:10,border:"none",background:full?C.cream:`linear-gradient(135deg,${C.greenAccent},${C.greenDark})`,color:full?C.textMuted:"#fff",fontWeight:600,fontSize:13,cursor:full?"default":"pointer",display:"flex",alignItems:"center",justifyContent:"center",gap:5}}>
          {full?"Event Full":<>Sign Up <I.ArrowRight/></>}
        </button>
      )}
      {isOwner&&(
        <button onClick={e=>{e.stopPropagation();onDelete(listing);}} title="Delete"
          style={btnStyle("danger",{padding:"9px 11px"})}
          onMouseEnter={e=>{e.currentTarget.style.borderColor=C.red;e.currentTarget.style.color=C.red;e.currentTarget.style.background=C.redLight;}}
          onMouseLeave={e=>{e.currentTarget.style.borderColor=C.border;e.currentTarget.style.color=C.textMuted;e.currentTarget.style.background="transparent";}}><I.Trash/></button>
      )}
    </div>
  </div>;
}

function VolunteerRoster({volunteerIds,isOwner}){
  const [volunteers,setVolunteers]=useState([]);
  const [loading,setLoading]=useState(true);
  const [copied,setCopied]=useState(false);
  useEffect(()=>{
    let cancelled=false;
    (async()=>{
      setLoading(true);
      try{const users=await fbGetUsersByIds(volunteerIds);if(!cancelled)setVolunteers(users);}catch(e){console.error(e);}
      if(!cancelled)setLoading(false);
    })();
    return()=>{cancelled=true;};
  },[volunteerIds.join(",")]);
  const emails=volunteers.map(v=>v.email).filter(Boolean);
  const copyEmails=()=>{if(emails.length===0)return;navigator.clipboard.writeText(emails.join(", ")).then(()=>{setCopied(true);setTimeout(()=>setCopied(false),2000);}).catch(()=>{});};
  const emailAll=()=>{if(emails.length>0)window.location.href=`mailto:${emails.join(",")}`;};
  return <div style={{background:C.white,borderRadius:16,border:`1.5px solid ${C.greenMid}40`,padding:24,boxShadow:`0 2px 12px ${C.shadow}`,marginTop:24}}>
    <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:16,flexWrap:"wrap",gap:10}}>
      <div style={{display:"flex",alignItems:"center",gap:10}}>
        <div style={{width:34,height:34,borderRadius:10,background:`linear-gradient(135deg,${C.greenAccent},${C.greenDark})`,display:"flex",alignItems:"center",justifyContent:"center",color:"#fff"}}><I.User/></div>
        <div>
          <h3 style={{fontFamily:"'Fraunces',serif",fontWeight:700,fontSize:17,color:C.textPrimary,margin:0}}>Signed-Up Volunteers</h3>
          <span style={{fontSize:12,color:C.textMuted}}>{volunteerIds.length} volunteer{volunteerIds.length!==1?"s":""} registered</span>
        </div>
      </div>
      {isOwner&&emails.length>0&&(
        <div style={{display:"flex",gap:7}}>
          <button onClick={copyEmails}
            style={{display:"flex",alignItems:"center",gap:4,padding:"6px 12px",borderRadius:8,border:`1.5px solid ${C.border}`,background:copied?C.greenLight:"transparent",color:copied?C.greenDark:C.textSecondary,fontWeight:600,fontSize:12,cursor:"pointer"}}>{copied?<><I.Check/>Copied!</>:<>Copy Emails</>}</button>
          <button onClick={emailAll}
            style={{display:"flex",alignItems:"center",gap:4,padding:"6px 12px",borderRadius:8,border:"none",background:`linear-gradient(135deg,${C.greenAccent},${C.greenDark})`,color:"#fff",fontWeight:600,fontSize:12,cursor:"pointer"}}><I.Mail/>Email All</button>
        </div>
      )}
    </div>
    {loading?<div style={{padding:"20px 0",textAlign:"center",color:C.textMuted,fontSize:14}}>Loading...</div>
    :volunteerIds.length===0?<div style={{padding:"20px 0",textAlign:"center"}}><p style={{fontSize:14,color:C.textMuted}}>No sign-ups yet.</p></div>
    :<div style={{overflowX:"auto"}}>
      <div style={{minWidth:300}}>
        <div style={{display:"grid",gridTemplateColumns:isOwner?"36px 1fr 1fr 90px":"36px 1fr 90px",padding:"8px 12px",background:C.cream,borderRadius:"8px 8px 0 0",fontSize:11,fontWeight:700,color:C.textMuted,letterSpacing:"0.05em",textTransform:"uppercase"}}>
          <span></span><span>Name</span>{isOwner&&<span>Email</span>}<span style={{textAlign:"right"}}>Hours</span>
        </div>
        {volunteers.map((v,i)=>(
          <div key={v.uid} style={{display:"grid",gridTemplateColumns:isOwner?"36px 1fr 1fr 90px":"36px 1fr 90px",padding:"10px 12px",alignItems:"center",borderBottom:i<volunteers.length-1?`1px solid ${C.borderLight}`:"none",background:i%2===0?"transparent":`${C.cream}40`}}>
            <Avatar name={v.name} size={28} profilePic={v.profilePic}/>
            <span style={{fontSize:13,fontWeight:500,color:C.textPrimary,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",paddingRight:6}}>{v.name||"Anonymous"}</span>
            {isOwner&&<a href={`mailto:${v.email||""}`} style={{fontSize:12,color:C.greenDark,textDecoration:"none",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",paddingRight:6}}>{v.email||"‚Äî"}</a>}
            <span style={{textAlign:"right",fontSize:13,fontWeight:700,color:C.greenAccent}}>{v.hoursServed||0}<span style={{fontSize:10,color:C.textMuted,fontWeight:400,marginLeft:2}}>hrs</span></span>
          </div>
        ))}
      </div>
    </div>}
  </div>;
}

function EventDetail({listing,signedUp,isOwner,onSignUp,onUnsign,onBack,onDelete}){
  const spots=listing.volunteersNeeded-listing.currentVolunteers;
  const full=spots<=0;
  return <div style={{animation:"fadeSlideIn 0.35s ease"}}>
    <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:14,gap:10,flexWrap:"wrap"}}>
      <button onClick={onBack} style={{background:"none",border:"none",color:C.textSecondary,fontSize:14,fontWeight:500,cursor:"pointer",display:"flex",alignItems:"center",gap:6}}>‚Üê Back to Events</button>
      {isOwner&&<button onClick={()=>onDelete(listing)}
        style={btnStyle("danger",{padding:"8px 14px",fontSize:13})}
        onMouseEnter={e=>{e.currentTarget.style.borderColor=C.red;e.currentTarget.style.color=C.red;e.currentTarget.style.background=C.redLight;}}
        onMouseLeave={e=>{e.currentTarget.style.borderColor=C.border;e.currentTarget.style.color=C.textMuted;e.currentTarget.style.background="transparent";}}><I.Trash/>Delete Listing</button>}
    </div>
    <div style={{background:C.white,borderRadius:20,border:`1px solid ${C.borderLight}`,padding:"28px 24px",boxShadow:`0 2px 12px ${C.shadow}`}}>
      <div style={{display:"flex",alignItems:"center",gap:8,marginBottom:4,flexWrap:"wrap"}}>
        <span style={{fontSize:12,fontWeight:600,color:C.greenAccent,letterSpacing:"0.06em",textTransform:"uppercase"}}>{listing.organizer}</span>
        {isOwner&&<span style={{background:C.cream,color:C.textSecondary,borderRadius:6,padding:"2px 7px",fontSize:10,fontWeight:600}}>Your Listing</span>}
      </div>
      <h1 style={{fontFamily:"'Fraunces',serif",fontWeight:800,fontSize:"clamp(22px,5vw,32px)",color:C.textPrimary,margin:"6px 0 14px 0",letterSpacing:"-0.02em",lineHeight:1.2}}>{listing.title}</h1>
      <p style={{fontSize:15,color:C.textSecondary,lineHeight:1.7,margin:"0 0 22px 0"}}>{listing.description}</p>
      <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(160px,1fr))",gap:12,marginBottom:22}}>
        {[{icon:<I.Calendar/>,label:"Date",value:formatDate(listing.date)},{icon:<I.Clock/>,label:"Time",value:listing.time},{icon:<I.MapPin/>,label:"Location",value:listing.location},{icon:<I.User/>,label:"Organized by",value:listing.createdByName}].map((x,i)=>(
          <div key={i} style={{background:C.cream,borderRadius:12,padding:"12px 14px",display:"flex",alignItems:"flex-start",gap:9}}>
            <div style={{color:C.greenAccent,marginTop:2,flexShrink:0}}>{x.icon}</div>
            <div style={{minWidth:0}}><div style={{fontSize:10,color:C.textMuted,fontWeight:600,letterSpacing:"0.04em",textTransform:"uppercase",marginBottom:2}}>{x.label}</div><div style={{fontSize:13,color:C.textPrimary,fontWeight:500,wordBreak:"break-word"}}>{x.value}</div></div>
          </div>
        ))}
      </div>
      <div style={{display:"flex",gap:10,marginBottom:22,flexWrap:"wrap"}}>
        {listing.contactEmail&&<a href={`mailto:${listing.contactEmail}`} style={{display:"flex",alignItems:"center",gap:5,padding:"7px 14px",borderRadius:10,background:C.greenLight,color:C.greenDark,fontSize:13,fontWeight:600,textDecoration:"none",wordBreak:"break-all"}}><I.Mail/>{listing.contactEmail}</a>}
        {listing.website&&<a href={listing.website} target="_blank" rel="noopener noreferrer" style={{display:"flex",alignItems:"center",gap:5,padding:"7px 14px",borderRadius:10,background:C.greenLight,color:C.greenDark,fontSize:13,fontWeight:600,textDecoration:"none"}}><I.Link/>Website</a>}
      </div>
      <div style={{marginBottom:20,maxWidth:400}}>
        <div style={{display:"flex",justifyContent:"space-between",marginBottom:7}}>
          <span style={{fontSize:14,color:C.textSecondary,fontWeight:500}}><span style={{fontWeight:700,color:C.greenDark,fontSize:17}}>{listing.currentVolunteers}</span> / {listing.volunteersNeeded} volunteers</span>
          <span style={{fontSize:13,color:full?C.textMuted:C.greenAccent,fontWeight:600}}>{full?"Full":`${spots} spots left`}</span>
        </div>
        <ProgressBar current={listing.currentVolunteers} total={listing.volunteersNeeded}/>
      </div>
      {signedUp?(
        <div style={{display:"flex",gap:10,alignItems:"center",flexWrap:"wrap"}}>
          <div style={{padding:"12px 24px",borderRadius:12,background:C.greenLight,color:C.greenDark,fontWeight:700,fontSize:15,display:"flex",alignItems:"center",gap:7}}><I.Check/>You're Registered</div>
          <button onClick={()=>onUnsign(listing.id)}
            style={btnStyle("danger",{padding:"12px 20px",fontSize:14})}
            onMouseEnter={e=>{e.currentTarget.style.borderColor=C.red;e.currentTarget.style.color=C.red;e.currentTarget.style.background=C.redLight;}}
            onMouseLeave={e=>{e.currentTarget.style.borderColor=C.border;e.currentTarget.style.color=C.textMuted;e.currentTarget.style.background="transparent";}}><I.X/>Cancel Registration</button>
        </div>
      ):(
        <button onClick={()=>{if(!full)onSignUp(listing.id);}} disabled={full}
          style={{padding:"12px 28px",borderRadius:12,border:"none",background:full?C.cream:`linear-gradient(135deg,${C.greenAccent},${C.greenDark})`,color:full?C.textMuted:"#fff",fontWeight:700,fontSize:15,cursor:full?"default":"pointer",display:"flex",alignItems:"center",gap:7}}>
          {full?"Event Full":<>Sign Up to Volunteer <I.ArrowRight/></>}
        </button>
      )}
    </div>
    {isOwner&&<VolunteerRoster volunteerIds={listing.volunteers||[]} isOwner={true}/>}
    {!isOwner&&(listing.volunteers||[]).length>0&&<VolunteerRoster volunteerIds={listing.volunteers||[]} isOwner={false}/>}
  </div>;
}

function LoginPage(){
  const [loading,setLoading]=useState(false);
  const [error,setError]=useState(null);
  const go=async()=>{setLoading(true);setError(null);try{await fbSignIn();}catch(e){setError(e.message||"Sign-in failed.");setLoading(false);}};
  return <div style={{minHeight:"100vh",background:C.offWhite,display:"flex",alignItems:"center",justifyContent:"center",padding:20}}>
    <div style={{background:C.white,borderRadius:24,border:`1px solid ${C.borderLight}`,padding:"40px 32px",maxWidth:420,width:"100%",textAlign:"center",boxShadow:`0 4px 24px ${C.shadowMd}`}}>
      <div style={{display:"flex",alignItems:"center",justifyContent:"center",gap:10,marginBottom:8}}>
        <div style={{width:42,height:42,borderRadius:12,overflow:"hidden",display:"flex",alignItems:"center",justifyContent:"center"}}><img src="voluntir.png" alt="Voluntir" style={{width:42,height:42,objectFit:"cover"}} onError={e=>e.target.style.display='none'}/></div>
        <span style={{fontFamily:"'Fraunces',serif",fontWeight:800,fontSize:28,color:C.textPrimary,letterSpacing:"-0.02em"}}>Voluntir</span>
      </div>
      <p style={{fontSize:15,color:C.textSecondary,marginBottom:32,lineHeight:1.6}}>Connect with your community. Find volunteer opportunities and track your impact.</p>
      {error&&<div style={{background:C.redLight,color:C.red,borderRadius:10,padding:"10px 14px",fontSize:13,marginBottom:16,textAlign:"left"}}>{error}</div>}
      <button onClick={go} disabled={loading}
        style={{width:"100%",padding:"14px 20px",borderRadius:12,border:`1.5px solid ${C.border}`,background:C.white,fontWeight:600,fontSize:15,color:C.textPrimary,cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",gap:10}}
        onMouseEnter={e=>e.currentTarget.style.borderColor=C.greenAccent}
        onMouseLeave={e=>e.currentTarget.style.borderColor=C.border}>
        <I.Google/>{loading?"Signing in...":"Continue with Google"}
      </button>
    </div>
  </div>;
}

function Navbar({currentPage,setCurrentPage,onLogout,onLogin,user,isMobile}){
  const [menuOpen,setMenuOpen]=useState(false);
  const guestLinks=[
    {id:"events",label:"Events",icon:<I.Calendar/>},
    {id:"leaderboard",label:"Leaderboard",icon:<I.Trophy/>},
  ];
  const authLinks=[
    {id:"events",label:"Events",icon:<I.Calendar/>},
    {id:"upcoming",label:"Upcoming",icon:<I.Clock/>},
    {id:"my-listings",label:"My Listings",icon:<I.List/>},
    {id:"leaderboard",label:"Leaderboard",icon:<I.Trophy/>},
    {id:"create",label:"Create",icon:<I.Plus/>},
    {id:"profile",label:"Profile",icon:<I.User/>},
  ];
  const links=user?authLinks:guestLinks;
  const nav=(p)=>{setMenuOpen(false);setCurrentPage(p);};

  if(isMobile){
    // Mobile: top bar with logo + sign in/out, bottom tab bar for nav
    const bottomLinks=user
      ?[{id:"events",label:"Events",icon:<I.Calendar/>},{id:"upcoming",label:"Upcoming",icon:<I.Clock/>},{id:"leaderboard",label:"Board",icon:<I.Trophy/>},{id:"create",label:"Create",icon:<I.Plus/>},{id:"profile",label:"Profile",icon:<I.User/>}]
      :[{id:"events",label:"Events",icon:<I.Calendar/>},{id:"leaderboard",label:"Leaderboard",icon:<I.Trophy/>}];
    return <>
      <nav style={{position:"sticky",top:0,zIndex:100,background:"rgba(255,255,255,0.96)",backdropFilter:"blur(16px)",WebkitBackdropFilter:"blur(16px)",borderBottom:`1px solid ${C.borderLight}`,padding:"0 16px",height:56,display:"flex",alignItems:"center",justifyContent:"space-between"}}>
        <div onClick={()=>nav("events")} style={{display:"flex",alignItems:"center",gap:8,cursor:"pointer"}}>
          <div style={{width:30,height:30,borderRadius:9,overflow:"hidden",display:"flex",alignItems:"center",justifyContent:"center"}}>
            <img src="voluntir.png" alt="" style={{width:30,height:30,objectFit:"cover"}} onError={e=>e.target.style.display='none'}/>
          </div>
          <span style={{fontFamily:"'Fraunces',serif",fontWeight:800,fontSize:20,color:C.textPrimary,letterSpacing:"-0.02em"}}>Voluntir</span>
        </div>
        {user?(
          <button onClick={onLogout} style={{display:"flex",alignItems:"center",gap:5,padding:"7px 12px",borderRadius:9,border:`1px solid ${C.border}`,background:"transparent",color:C.textMuted,fontSize:12,fontWeight:600,cursor:"pointer"}}><I.Logout/>Log out</button>
        ):(
          <button onClick={onLogin} style={{display:"flex",alignItems:"center",gap:5,padding:"7px 14px",borderRadius:9,border:"none",background:`linear-gradient(135deg,${C.greenAccent},${C.greenDark})`,color:"#fff",fontWeight:600,fontSize:13,cursor:"pointer"}}><I.Google/>Sign In</button>
        )}
      </nav>
      {/* Bottom tab bar */}
      <div style={{position:"fixed",bottom:0,left:0,right:0,zIndex:100,background:"rgba(255,255,255,0.97)",backdropFilter:"blur(16px)",WebkitBackdropFilter:"blur(16px)",borderTop:`1px solid ${C.borderLight}`,display:"flex",alignItems:"stretch",paddingBottom:"env(safe-area-inset-bottom,0px)"}}>
        {bottomLinks.map(l=>(
          <button key={l.id} onClick={()=>nav(l.id)}
            style={{flex:1,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",gap:3,padding:"8px 4px",border:"none",background:"transparent",color:currentPage===l.id?C.greenDark:C.textMuted,cursor:"pointer",minHeight:52,transition:"all 0.2s"}}>
            <div style={{color:currentPage===l.id?C.greenAccent:C.textMuted,transition:"color 0.2s"}}>{l.icon}</div>
            <span style={{fontSize:10,fontWeight:currentPage===l.id?700:500,letterSpacing:"0.01em"}}>{l.label}</span>
            {currentPage===l.id&&<div style={{position:"absolute",bottom:0,width:28,height:2,borderRadius:2,background:C.greenAccent}}/>}
          </button>
        ))}
      </div>
    </>;
  }

  // Desktop nav
  return <nav style={{position:"sticky",top:0,zIndex:100,background:"rgba(255,255,255,0.92)",backdropFilter:"blur(16px)",WebkitBackdropFilter:"blur(16px)",borderBottom:`1px solid ${C.borderLight}`,padding:"0 24px"}}>
    <div style={{maxWidth:1200,margin:"0 auto",display:"flex",alignItems:"center",justifyContent:"space-between",height:64}}>
      <div onClick={()=>nav("events")} style={{display:"flex",alignItems:"center",gap:8,cursor:"pointer",userSelect:"none"}}>
        <div style={{width:34,height:34,borderRadius:10,overflow:"hidden",display:"flex",alignItems:"center",justifyContent:"center"}}>
          <img src="voluntir.png" alt="Voluntir" style={{width:34,height:34,objectFit:"cover"}} onError={e=>e.target.style.display='none'}/>
        </div>
        <span style={{fontFamily:"'Fraunces',serif",fontWeight:800,fontSize:22,color:C.textPrimary,letterSpacing:"-0.02em"}}>Voluntir</span>
      </div>
      <div style={{display:"flex",alignItems:"center",gap:3}}>
        {links.map(l=>(
          <button key={l.id} onClick={()=>nav(l.id)}
            style={{display:"flex",alignItems:"center",gap:6,padding:"8px 12px",borderRadius:10,border:"none",background:currentPage===l.id?C.greenLight:"transparent",color:currentPage===l.id?C.greenDark:C.textSecondary,fontWeight:currentPage===l.id?600:500,fontSize:14,cursor:"pointer",transition:"all 0.2s"}}>
            {l.icon}<span>{l.label}</span>
          </button>
        ))}
        <div style={{width:1,height:24,background:C.borderLight,margin:"0 6px"}}/>
        {user?(
          <button onClick={onLogout} style={{display:"flex",alignItems:"center",gap:6,padding:"8px 12px",borderRadius:10,border:"none",background:"transparent",color:C.textMuted,fontSize:13,cursor:"pointer"}}><I.Logout/>Log out</button>
        ):(
          <button onClick={onLogin}
            style={{display:"flex",alignItems:"center",gap:6,padding:"8px 16px",borderRadius:10,border:"none",background:`linear-gradient(135deg,${C.greenAccent},${C.greenDark})`,color:"#fff",fontWeight:600,fontSize:13,cursor:"pointer"}}>
            <I.Google/>Sign In
          </button>
        )}
      </div>
    </div>
  </nav>;
}

function EventsPage({listings,user,onSignUp,onUnsign,onDelete,onRefresh,refreshing,initialSel,onRequireLogin,isMobile}){
  const [sel,setSel]=useState(initialSel||null);
  const [search,setSearch]=useState("");
  const today=getTodayStr();
  // Only show listings from today onwards
  const upcoming=listings.filter(l=>l.date>=today);
  const filtered=upcoming.filter(l=>
    l.title.toLowerCase().includes(search.toLowerCase())||
    (l.organizer||"").toLowerCase().includes(search.toLowerCase())||
    (l.location||"").toLowerCase().includes(search.toLowerCase())
  );
  const uid=user?user.uid:null;
  if(sel){const li=listings.find(l=>l.id===sel);if(li)return <EventDetail listing={li} signedUp={uid?(li.volunteers||[]).includes(uid):false} isOwner={uid?li.createdBy===uid:false} onSignUp={uid?onSignUp:onRequireLogin} onUnsign={uid?onUnsign:onRequireLogin} onBack={()=>setSel(null)} onDelete={l=>{onDelete(l);setSel(null);}}/>;} 
  return <div style={{animation:"fadeSlideIn 0.35s ease"}}>
    <div style={{display:"flex",alignItems:"flex-start",justifyContent:"space-between",marginBottom:22,gap:12}}>
      <div>
        <h1 style={{fontFamily:"'Fraunces',serif",fontWeight:800,fontSize:"clamp(22px,5vw,30px)",color:C.textPrimary,margin:"0 0 5px 0",letterSpacing:"-0.02em"}}>Volunteer Events</h1>
        <p style={{fontSize:14,color:C.textSecondary}}>Find opportunities to make a difference.</p>
      </div>
      <button onClick={onRefresh} disabled={refreshing}
        style={{display:"flex",alignItems:"center",gap:5,padding:"9px 14px",borderRadius:10,border:`1.5px solid ${C.border}`,background:C.white,color:C.textSecondary,fontSize:13,fontWeight:600,cursor:"pointer",flexShrink:0}}
        onMouseEnter={e=>{e.currentTarget.style.borderColor=C.greenAccent;e.currentTarget.style.color=C.greenDark;}}
        onMouseLeave={e=>{e.currentTarget.style.borderColor=C.border;e.currentTarget.style.color=C.textSecondary;}}>
        <span style={{display:"inline-block",animation:refreshing?"spin 1s linear infinite":"none"}}><I.Refresh/></span>
        {!isMobile&&(refreshing?"Refreshing...":"Refresh")}
      </button>
    </div>
    <div style={{marginBottom:20}}>
      <input type="text" placeholder="Search events, organizations, or locations‚Ä¶" value={search} onChange={e=>setSearch(e.target.value)}
        style={{width:"100%",padding:"11px 16px",borderRadius:12,border:`1.5px solid ${C.border}`,background:C.white,fontSize:14,color:C.textPrimary,outline:"none",boxSizing:"border-box"}}
        onFocus={e=>e.target.style.borderColor=C.greenAccent} onBlur={e=>e.target.style.borderColor=C.border}/>
    </div>
    {filtered.length===0
      ?<div style={{textAlign:"center",padding:"50px 20px"}}><div style={{fontSize:40,marginBottom:12}}>üìÖ</div><p style={{fontSize:16,color:C.textMuted,marginBottom:6}}>{upcoming.length===0?"No upcoming events at the moment.":"No events match your search."}</p></div>
      :<div className="events-grid" style={{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(300px,1fr))",gap:16}}>
        {filtered.map(l=><EventCard key={l.id} listing={l} signedUp={uid?(l.volunteers||[]).includes(uid):false} isOwner={uid?l.createdBy===uid:false} onSignUp={uid?onSignUp:onRequireLogin} onUnsign={uid?onUnsign:onRequireLogin} onView={()=>setSel(l.id)} onDelete={onDelete}/>)}
      </div>
    }
  </div>;
}

function UpcomingPage({listings,user,onUnsign,onView}){
  const today=getTodayStr();
  const upcoming=listings.filter(l=>(l.volunteers||[]).includes(user.uid)&&l.date>=today);
  return <div style={{animation:"fadeSlideIn 0.35s ease"}}>
    <div style={{marginBottom:22}}>
      <h1 style={{fontFamily:"'Fraunces',serif",fontWeight:800,fontSize:"clamp(22px,5vw,30px)",color:C.textPrimary,margin:"0 0 5px 0",letterSpacing:"-0.02em"}}>Your Upcoming Events</h1>
      <p style={{fontSize:14,color:C.textSecondary}}>Events you've signed up for.</p>
    </div>
    {upcoming.length===0
      ?<div style={{background:C.white,borderRadius:16,border:`1px solid ${C.borderLight}`,padding:"50px 20px",textAlign:"center"}}>
        <div style={{fontSize:40,marginBottom:14}}>üå±</div>
        <h3 style={{fontFamily:"'Fraunces',serif",fontWeight:700,fontSize:19,color:C.textPrimary,margin:"0 0 7px 0"}}>No upcoming events yet</h3>
        <p style={{fontSize:14,color:C.textSecondary}}>Browse events and sign up to start volunteering!</p>
      </div>
      :<div style={{display:"flex",flexDirection:"column",gap:14}}>
        {upcoming.map(l=>(
          <div key={l.id} onClick={()=>onView(l.id)}
            style={{background:C.white,borderRadius:16,border:`1px solid ${C.borderLight}`,padding:20,display:"flex",alignItems:"center",gap:16,boxShadow:`0 1px 3px ${C.shadow}`,cursor:"pointer",transition:"all 0.2s",flexWrap:"wrap"}}
            onMouseEnter={e=>{e.currentTarget.style.boxShadow=`0 6px 20px ${C.shadowMd}`;e.currentTarget.style.borderColor=C.greenMid;}}
            onMouseLeave={e=>{e.currentTarget.style.boxShadow=`0 1px 3px ${C.shadow}`;e.currentTarget.style.borderColor=C.borderLight;}}>
            <div style={{width:48,height:48,borderRadius:12,background:`linear-gradient(135deg,${C.greenLight},${C.greenMid}40)`,display:"flex",alignItems:"center",justifyContent:"center",color:C.greenDark,flexShrink:0}}><I.Calendar/></div>
            <div style={{flex:1,minWidth:200}}>
              <h3 style={{fontFamily:"'Fraunces',serif",fontWeight:700,fontSize:17,color:C.textPrimary,margin:"0 0 4px 0"}}>{l.title}</h3>
              <div style={{display:"flex",flexWrap:"wrap",gap:10}}>
                {[{icon:<I.Calendar/>,t:formatDate(l.date)},{icon:<I.Clock/>,t:l.time},{icon:<I.MapPin/>,t:l.location}].map((x,i)=>(
                  <span key={i} style={{fontSize:12,color:C.textMuted,display:"flex",alignItems:"center",gap:3}}>{x.icon}{x.t}</span>
                ))}
              </div>
            </div>
            <div style={{display:"flex",alignItems:"center",gap:8,flexShrink:0}}>
              <div style={{background:C.greenAccent,color:"#fff",borderRadius:8,padding:"5px 10px",fontSize:11,fontWeight:700,textTransform:"uppercase",display:"flex",alignItems:"center",gap:3}}><I.Check/>Confirmed</div>
              <button onClick={e=>{e.stopPropagation();onUnsign(l.id);}}
                style={btnStyle("danger",{padding:"5px 10px",fontSize:12})}
                onMouseEnter={e=>{e.currentTarget.style.borderColor=C.red;e.currentTarget.style.color=C.red;e.currentTarget.style.background=C.redLight;}}
                onMouseLeave={e=>{e.currentTarget.style.borderColor=C.border;e.currentTarget.style.color=C.textMuted;e.currentTarget.style.background="transparent";}}><I.X/>Cancel</button>
            </div>
          </div>
        ))}
      </div>
    }
  </div>;
}

function MyListingsPage({listings,user,onDelete,onView}){
  const mine=listings.filter(l=>l.createdBy===user.uid);
  return <div style={{animation:"fadeSlideIn 0.35s ease"}}>
    <div style={{marginBottom:22}}>
      <h1 style={{fontFamily:"'Fraunces',serif",fontWeight:800,fontSize:"clamp(22px,5vw,30px)",color:C.textPrimary,margin:"0 0 5px 0",letterSpacing:"-0.02em"}}>My Listings</h1>
      <p style={{fontSize:14,color:C.textSecondary}}>Events you've posted for the community.</p>
    </div>
    {mine.length===0
      ?<div style={{background:C.white,borderRadius:16,border:`1px solid ${C.borderLight}`,padding:"50px 20px",textAlign:"center"}}>
        <div style={{fontSize:40,marginBottom:14}}>üìã</div>
        <h3 style={{fontFamily:"'Fraunces',serif",fontWeight:700,fontSize:19,color:C.textPrimary,margin:"0 0 7px 0"}}>No listings yet</h3>
        <p style={{fontSize:14,color:C.textSecondary}}>Head to Create to post your first volunteer opportunity!</p>
      </div>
      :<div style={{display:"flex",flexDirection:"column",gap:14}}>
        {mine.map(l=>{
          const pct=Math.round((l.currentVolunteers/l.volunteersNeeded)*100);
          const full=l.currentVolunteers>=l.volunteersNeeded;
          const isPast=l.date<getTodayStr();
          return <div key={l.id} onClick={()=>onView(l.id)}
            style={{background:C.white,borderRadius:16,border:`1px solid ${isPast?C.border:C.borderLight}`,padding:20,boxShadow:`0 1px 3px ${C.shadow}`,cursor:"pointer",transition:"all 0.2s",opacity:isPast?0.7:1}}
            onMouseEnter={e=>{e.currentTarget.style.boxShadow=`0 6px 20px ${C.shadowMd}`;e.currentTarget.style.borderColor=C.greenMid;}}
            onMouseLeave={e=>{e.currentTarget.style.boxShadow=`0 1px 3px ${C.shadow}`;e.currentTarget.style.borderColor=isPast?C.border:C.borderLight;}}>
            <div style={{display:"flex",alignItems:"flex-start",justifyContent:"space-between",gap:12}}>
              <div style={{flex:1,minWidth:0}}>
                <div style={{display:"flex",alignItems:"center",gap:8,marginBottom:4,flexWrap:"wrap"}}>
                  <span style={{fontSize:11,fontWeight:600,color:C.greenAccent,letterSpacing:"0.06em",textTransform:"uppercase"}}>{l.organizer}</span>
                  {isPast&&<span style={{background:"#FEF3CD",color:"#856404",borderRadius:6,padding:"2px 7px",fontSize:10,fontWeight:600}}>Past Event</span>}
                </div>
                <h3 style={{fontFamily:"'Fraunces',serif",fontWeight:700,fontSize:18,color:C.textPrimary,margin:"0 0 7px 0"}}>{l.title}</h3>
                <div style={{display:"flex",flexWrap:"wrap",gap:12,marginBottom:10}}>
                  {[{icon:<I.Calendar/>,t:formatDate(l.date)},{icon:<I.Clock/>,t:l.time},{icon:<I.MapPin/>,t:l.location}].map((x,i)=>(
                    <span key={i} style={{fontSize:12,color:C.textMuted,display:"flex",alignItems:"center",gap:4}}>{x.icon}{x.t}</span>
                  ))}
                </div>
                <div style={{maxWidth:300}}>
                  <div style={{display:"flex",justifyContent:"space-between",marginBottom:5}}>
                    <span style={{fontSize:12,color:C.textSecondary,fontWeight:500}}><span style={{fontWeight:700,color:C.greenDark}}>{l.currentVolunteers}</span> / {l.volunteersNeeded} volunteers</span>
                    <span style={{fontSize:11,fontWeight:700,color:full?C.greenDark:C.textMuted}}>{full?"Full!":`${pct}%`}</span>
                  </div>
                  <ProgressBar current={l.currentVolunteers} total={l.volunteersNeeded}/>
                </div>
              </div>
              <button onClick={e=>{e.stopPropagation();onDelete(l);}}
                style={btnStyle("danger",{padding:"8px 12px",fontSize:13,flexShrink:0})}
                onMouseEnter={e=>{e.currentTarget.style.borderColor=C.red;e.currentTarget.style.color=C.red;e.currentTarget.style.background=C.redLight;}}
                onMouseLeave={e=>{e.currentTarget.style.borderColor=C.border;e.currentTarget.style.color=C.textMuted;e.currentTarget.style.background="transparent";}}><I.Trash/>Delete</button>
            </div>
          </div>;
        })}
      </div>
    }
  </div>;
}

function LeaderboardPage({leaderboard,user,onViewProfile,isMobile}){
  const [tab,setTab]=useState("volunteers");
  const schoolMap={};
  leaderboard.forEach(p=>{
    if(p.school&&p.school.trim()){
      const s=p.school.trim();
      if(!schoolMap[s])schoolMap[s]={name:s,totalHours:0,members:0};
      schoolMap[s].totalHours+=(p.hoursServed||0);
      schoolMap[s].members+=1;
    }
  });
  const schoolBoard=Object.values(schoolMap).sort((a,b)=>b.totalHours-a.totalHours);
  const top3=leaderboard.slice(0,3);
  const pod=[1,0,2].map(i=>top3[i]).filter(Boolean);
  const podRanks=["2nd","1st","3rd"];
  const schoolTop3=schoolBoard.slice(0,3);
  const schoolPod=[1,0,2].map(i=>schoolTop3[i]).filter(Boolean);
  const tabBtn=(id,label,icon)=>({
    padding:isMobile?"8px 14px":"10px 22px",borderRadius:10,border:"none",
    background:tab===id?C.greenLight:"transparent",
    color:tab===id?C.greenDark:C.textSecondary,
    fontWeight:tab===id?700:500,fontSize:isMobile?13:14,cursor:"pointer",transition:"all 0.2s"
  });
  return <div style={{animation:"fadeSlideIn 0.35s ease"}}>
    <div style={{marginBottom:18,textAlign:"center"}}>
      <h1 style={{fontFamily:"'Fraunces',serif",fontWeight:800,fontSize:"clamp(22px,5vw,30px)",color:C.textPrimary,margin:"0 0 5px 0",letterSpacing:"-0.02em"}}>Service Leaderboard</h1>
      <p style={{fontSize:14,color:C.textSecondary}}>Celebrating our top volunteers and schools.</p>
    </div>
    <div style={{display:"flex",justifyContent:"center",gap:3,marginBottom:24,background:C.white,borderRadius:12,padding:4,width:"fit-content",margin:"0 auto 24px auto",border:`1px solid ${C.borderLight}`}}>
      <button onClick={()=>setTab("volunteers")} style={tabBtn("volunteers")}><span style={{display:"flex",alignItems:"center",gap:5}}><I.User/>Volunteers</span></button>
      <button onClick={()=>setTab("schools")} style={tabBtn("schools")}><span style={{display:"flex",alignItems:"center",gap:5}}><I.School/>Schools</span></button>
    </div>
    {tab==="volunteers"&&<>
      {top3.length>0&&(
        <div style={{display:"flex",justifyContent:"center",alignItems:"flex-end",gap:isMobile?10:14,marginBottom:28,overflowX:"auto",paddingBottom:4}}>
          {pod.map((p,di)=>{
            const best=di===1;
            const ht=isMobile?(best?200:170):(best?250:210);
            const w=isMobile?(best?150:130):(best?180:160);
            return <div key={p.uid} style={{background:C.white,borderRadius:16,padding:isMobile?"18px 12px":"24px 16px",textAlign:"center",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"flex-end",minHeight:ht,width:w,flexShrink:0,border:best?`2px solid ${C.greenAccent}`:`1px solid ${C.borderLight}`,boxShadow:best?`0 4px 20px ${C.shadowMd}`:`0 1px 3px ${C.shadow}`,cursor:"pointer"}} onClick={()=>onViewProfile&&onViewProfile(p.uid)}>
              <div style={{fontSize:12,fontWeight:700,color:best?C.greenAccent:C.textMuted,marginBottom:8}}>{podRanks[di]}</div>
              <Avatar name={p.name} size={best?52:40} profilePic={p.profilePic}/>
              <h3 style={{fontFamily:"'Fraunces',serif",fontWeight:700,fontSize:best?15:13,color:C.textPrimary,margin:"8px 0 2px 0",lineHeight:1.2}}>{p.name}</h3>
              {p.school&&<span style={{fontSize:10,color:C.textMuted,marginBottom:3}}>{p.school}</span>}
              <span style={{fontSize:22,fontWeight:800,color:C.greenAccent}}>{p.hoursServed}</span>
              <span style={{fontSize:11,color:C.textMuted}}>hours</span>
            </div>;
          })}
        </div>
      )}
      <div style={{background:C.white,borderRadius:16,border:`1px solid ${C.borderLight}`,overflow:"hidden",boxShadow:`0 1px 3px ${C.shadow}`}}>
        <div style={{display:"grid",gridTemplateColumns:isMobile?"40px 1fr 80px":"50px 1fr 140px 120px",padding:"12px 16px",background:C.cream,fontSize:10,fontWeight:700,color:C.textMuted,letterSpacing:"0.05em",textTransform:"uppercase"}}>
          <span style={{textAlign:"center"}}>Rank</span><span>Volunteer</span>{!isMobile&&<span>School</span>}<span style={{textAlign:"right"}}>Hours</span>
        </div>
        {leaderboard.length===0&&<div style={{padding:"36px 20px",textAlign:"center",fontSize:14,color:C.textMuted}}>No volunteers yet. Sign up for an event to appear here!</div>}
        {leaderboard.map((p,i)=>(
          <div key={p.uid} onClick={()=>onViewProfile&&onViewProfile(p.uid)} style={{display:"grid",gridTemplateColumns:isMobile?"40px 1fr 80px":"50px 1fr 140px 120px",padding:"12px 16px",alignItems:"center",borderTop:i>0?`1px solid ${C.borderLight}`:"none",background:p.uid===user.uid?`${C.greenLight}60`:"transparent",cursor:"pointer"}}
            onMouseEnter={e=>{if(p.uid!==user.uid)e.currentTarget.style.background=`${C.cream}80`;}}
            onMouseLeave={e=>{e.currentTarget.style.background=p.uid===user.uid?`${C.greenLight}60`:"transparent";}}>
            <span style={{fontSize:13,fontWeight:700,color:i<3?C.greenAccent:C.textMuted,textAlign:"center"}}>#{i+1}</span>
            <div style={{display:"flex",alignItems:"center",gap:10,minWidth:0}}>
              <Avatar name={p.name} size={32} rank={i} profilePic={p.profilePic}/>
              <span style={{fontSize:13,fontWeight:p.uid===user.uid?700:500,color:C.textPrimary,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{p.name}{p.uid===user.uid&&<span style={{fontSize:10,color:C.greenAccent,marginLeft:5,fontWeight:600}}>(You)</span>}</span>
            </div>
            {!isMobile&&<span style={{fontSize:12,color:C.textMuted,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{p.school||"‚Äî"}</span>}
            <div style={{textAlign:"right"}}><span style={{fontSize:15,fontWeight:700,color:C.greenDark}}>{p.hoursServed}</span><span style={{fontSize:11,color:C.textMuted,marginLeft:3}}>hrs</span></div>
          </div>
        ))}
      </div>
    </>}
    {tab==="schools"&&<>
      {schoolPod.length>0&&(
        <div style={{display:"flex",justifyContent:"center",alignItems:"flex-end",gap:isMobile?10:14,marginBottom:28,overflowX:"auto",paddingBottom:4}}>
          {schoolPod.map((s,di)=>{
            const best=di===1;
            const ht=isMobile?(best?190:160):(best?230:195);
            return <div key={s.name} style={{background:C.white,borderRadius:16,padding:isMobile?"16px 12px":"24px 16px",textAlign:"center",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"flex-end",minHeight:ht,width:isMobile?140:190,flexShrink:0,border:best?`2px solid ${C.greenAccent}`:`1px solid ${C.borderLight}`,boxShadow:best?`0 4px 20px ${C.shadowMd}`:`0 1px 3px ${C.shadow}`}}>
              <div style={{fontSize:12,fontWeight:700,color:best?C.greenAccent:C.textMuted,marginBottom:8}}>{podRanks[di]}</div>
              <div style={{width:best?48:38,height:best?48:38,borderRadius:12,background:`linear-gradient(135deg,${C.greenLight},${C.greenMid}40)`,display:"flex",alignItems:"center",justifyContent:"center",color:C.greenDark,marginBottom:7}}><I.School/></div>
              <h3 style={{fontFamily:"'Fraunces',serif",fontWeight:700,fontSize:best?14:12,color:C.textPrimary,margin:"0 0 2px 0",lineHeight:1.3}}>{s.name}</h3>
              <span style={{fontSize:10,color:C.textMuted,marginBottom:4}}>{s.members} member{s.members!==1?"s":""}</span>
              <span style={{fontSize:22,fontWeight:800,color:C.greenAccent}}>{s.totalHours}</span>
              <span style={{fontSize:11,color:C.textMuted}}>hours</span>
            </div>;
          })}
        </div>
      )}
      <div style={{background:C.white,borderRadius:16,border:`1px solid ${C.borderLight}`,overflow:"hidden",boxShadow:`0 1px 3px ${C.shadow}`}}>
        <div style={{display:"grid",gridTemplateColumns:isMobile?"1fr 60px 80px":"50px 1fr 100px 120px",padding:"12px 16px",background:C.cream,fontSize:10,fontWeight:700,color:C.textMuted,letterSpacing:"0.05em",textTransform:"uppercase"}}>
          {!isMobile&&<span style={{textAlign:"center"}}>Rank</span>}<span>School</span><span style={{textAlign:"center"}}>Members</span><span style={{textAlign:"right"}}>Hrs</span>
        </div>
        {schoolBoard.length===0&&<div style={{padding:"36px 20px",textAlign:"center",fontSize:14,color:C.textMuted}}>No schools yet. Add your school in Profile!</div>}
        {schoolBoard.map((s,i)=>{
          const userSchool=user&&leaderboard.find(p=>p.uid===user.uid);
          const isMySchool=userSchool&&userSchool.school&&userSchool.school.trim()===s.name;
          return <div key={s.name} style={{display:"grid",gridTemplateColumns:isMobile?"1fr 60px 80px":"50px 1fr 100px 120px",padding:"12px 16px",alignItems:"center",borderTop:i>0?`1px solid ${C.borderLight}`:"none",background:isMySchool?`${C.greenLight}60`:"transparent"}}>
            {!isMobile&&<span style={{fontSize:13,fontWeight:700,color:i<3?C.greenAccent:C.textMuted,textAlign:"center"}}>#{i+1}</span>}
            <div style={{display:"flex",alignItems:"center",gap:8,minWidth:0}}>
              {isMobile&&<span style={{fontSize:11,fontWeight:700,color:i<3?C.greenAccent:C.textMuted,minWidth:20}}>#{i+1}</span>}
              <span style={{fontSize:13,fontWeight:isMySchool?700:500,color:C.textPrimary,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{s.name}{isMySchool&&<span style={{fontSize:10,color:C.greenAccent,marginLeft:4,fontWeight:600}}>(You)</span>}</span>
            </div>
            <span style={{fontSize:13,color:C.textMuted,textAlign:"center"}}>{s.members}</span>
            <div style={{textAlign:"right"}}><span style={{fontSize:14,fontWeight:700,color:C.greenDark}}>{s.totalHours}</span></div>
          </div>;
        })}
      </div>
    </>}
  </div>;
}

function CreateListingPage({user,onCreateListing,isMobile}){
  const today=getTodayStr();
  const [form,setForm]=useState({title:"",description:"",volunteersNeeded:"",date:"",startTime:"",endTime:"",location:"",organizer:"",contactEmail:"",website:""});
  const [submitted,setSubmitted]=useState(false);
  const [saving,setSaving]=useState(false);
  const set=f=>setForm(p=>({...p,...f}));
  const go=async()=>{
    if(!form.title||!form.date||!form.volunteersNeeded||!form.startTime||!form.endTime)return;
    setSaving(true);
    const data={title:form.title,description:form.description,volunteersNeeded:parseInt(form.volunteersNeeded),date:form.date,time:buildTimeStr(form.startTime,form.endTime),location:form.location,organizer:form.organizer,contactEmail:form.contactEmail,website:form.website,currentVolunteers:0,volunteers:[],createdBy:user.uid,createdByName:user.displayName||"Anonymous"};
    await onCreateListing(data);
    setSaving(false);setSubmitted(true);
    setTimeout(()=>{setSubmitted(false);setForm({title:"",description:"",volunteersNeeded:"",date:"",startTime:"",endTime:"",location:"",organizer:"",contactEmail:"",website:""}); },3000);
  };
  const inp={width:"100%",padding:"11px 14px",borderRadius:10,border:`1.5px solid ${C.border}`,background:C.white,fontSize:14,color:C.textPrimary,outline:"none",boxSizing:"border-box"};
  const lbl={fontSize:13,fontWeight:600,color:C.textSecondary,marginBottom:5,display:"block"};
  const ok=form.title&&form.date&&form.volunteersNeeded&&form.startTime&&form.endTime;
  if(submitted)return <div style={{animation:"fadeSlideIn 0.35s ease",maxWidth:640,margin:"0 auto"}}>
    <div style={{background:C.white,borderRadius:16,border:`2px solid ${C.greenAccent}`,padding:"50px 24px",textAlign:"center",boxShadow:`0 4px 20px ${C.shadowMd}`}}>
      <div style={{fontSize:48,marginBottom:14}}>üéâ</div>
      <h2 style={{fontFamily:"'Fraunces',serif",fontWeight:700,fontSize:22,color:C.greenDark,margin:"0 0 7px 0"}}>Listing Created!</h2>
      <p style={{fontSize:15,color:C.textSecondary}}>Your event is now live and open for volunteers.</p>
    </div>
  </div>;
  return <div style={{animation:"fadeSlideIn 0.35s ease",maxWidth:640,margin:"0 auto"}}>
    <div style={{marginBottom:22}}>
      <h1 style={{fontFamily:"'Fraunces',serif",fontWeight:800,fontSize:"clamp(22px,5vw,30px)",color:C.textPrimary,margin:"0 0 5px 0",letterSpacing:"-0.02em"}}>Create a Listing</h1>
      <p style={{fontSize:14,color:C.textSecondary}}>Post a new volunteer opportunity for the community.</p>
    </div>
    <div style={{background:C.white,borderRadius:16,border:`1px solid ${C.borderLight}`,padding:isMobile?20:28,boxShadow:`0 1px 3px ${C.shadow}`}}>
      <div style={{display:"flex",flexDirection:"column",gap:18}}>
        <div><label style={lbl}>Organization Name</label><input style={inp} placeholder="e.g., Portland Food Alliance" value={form.organizer} onChange={e=>set({organizer:e.target.value})} onFocus={e=>e.target.style.borderColor=C.greenAccent} onBlur={e=>e.target.style.borderColor=C.border}/></div>
        <div><label style={lbl}>Event Title *</label><input style={inp} placeholder="e.g., Weekend Food Drive" value={form.title} onChange={e=>set({title:e.target.value})} onFocus={e=>e.target.style.borderColor=C.greenAccent} onBlur={e=>e.target.style.borderColor=C.border}/></div>
        <div><label style={lbl}>Description</label><textarea style={{...inp,minHeight:90,resize:"vertical"}} placeholder="Describe the volunteer opportunity‚Ä¶" value={form.description} onChange={e=>set({description:e.target.value})} onFocus={e=>e.target.style.borderColor=C.greenAccent} onBlur={e=>e.target.style.borderColor=C.border}/></div>
        <div style={{display:"grid",gridTemplateColumns:isMobile?"1fr":"1fr 1fr",gap:14}}>
          <div><label style={lbl}># Volunteers Needed *</label><input style={inp} type="number" min="1" placeholder="e.g., 20" value={form.volunteersNeeded} onChange={e=>set({volunteersNeeded:e.target.value})} onFocus={e=>e.target.style.borderColor=C.greenAccent} onBlur={e=>e.target.style.borderColor=C.border}/></div>
          <div>
            <label style={lbl}>Date * <span style={{color:C.textMuted,fontWeight:400,fontSize:11}}>(today or later)</span></label>
            <input style={inp} type="date" min={today} value={form.date} onChange={e=>set({date:e.target.value})} onFocus={e=>e.target.style.borderColor=C.greenAccent} onBlur={e=>e.target.style.borderColor=C.border}/>
          </div>
        </div>
        <div>
          <label style={lbl}>Event Time * <span style={{color:C.textMuted,fontWeight:400,fontSize:11}}>(auto-calculates volunteer hours)</span></label>
          <TimePicker startVal={form.startTime} endVal={form.endTime} onStartChange={v=>set({startTime:v})} onEndChange={v=>set({endTime:v})}/>
        </div>
        <div><label style={lbl}>Location</label><input style={inp} placeholder="e.g., 123 Main St, Portland, OR" value={form.location} onChange={e=>set({location:e.target.value})} onFocus={e=>e.target.style.borderColor=C.greenAccent} onBlur={e=>e.target.style.borderColor=C.border}/></div>
        <div style={{display:"grid",gridTemplateColumns:isMobile?"1fr":"1fr 1fr",gap:14}}>
          <div><label style={lbl}>Contact Email</label><input style={inp} type="email" placeholder="contact@org.com" value={form.contactEmail} onChange={e=>set({contactEmail:e.target.value})} onFocus={e=>e.target.style.borderColor=C.greenAccent} onBlur={e=>e.target.style.borderColor=C.border}/></div>
          <div><label style={lbl}>Website</label><input style={inp} type="url" placeholder="https://yourorg.com" value={form.website} onChange={e=>set({website:e.target.value})} onFocus={e=>e.target.style.borderColor=C.greenAccent} onBlur={e=>e.target.style.borderColor=C.border}/></div>
        </div>
        <button onClick={go} disabled={!ok||saving}
          style={{padding:"13px 24px",borderRadius:12,border:"none",background:ok?`linear-gradient(135deg,${C.greenAccent},${C.greenDark})`:C.border,color:ok?"#fff":C.textMuted,fontWeight:700,fontSize:15,cursor:ok?"pointer":"not-allowed",display:"flex",alignItems:"center",justifyContent:"center",gap:7}}>
          <I.Plus/>{saving?"Publishing‚Ä¶":"Publish Listing"}
        </button>
      </div>
    </div>
  </div>;
}

function ProfilePage({user,profile,setProfile,listings,leaderboard,onView,isMobile}){
  const [editing,setEditing]=useState(false);
  const [form,setForm]=useState(profile);
  const fileInputRef=useRef(null);
  const [previewPic,setPreviewPic]=useState(null);
  useEffect(()=>{setForm(profile);setPreviewPic(profile.profilePic||null);},[profile]);
  const signedUp=listings.filter(l=>(l.volunteers||[]).includes(user.uid)&&l.date>=getTodayStr());
  const rank=leaderboard.findIndex(p=>p.uid===user.uid)+1;
  const handleImageUpload=(e)=>{
    const file=e.target.files[0];if(!file)return;
    if(file.size>500000){alert("Image too large. Please choose an image under 500KB.");return;}
    const reader=new FileReader();
    reader.onloadend=()=>{
      const img=new Image();
      img.onload=()=>{
        const canvas=document.createElement("canvas");const MAX=200;
        let w=img.width,h=img.height;
        if(w>h){if(w>MAX){h*=MAX/w;w=MAX;}}else{if(h>MAX){w*=MAX/h;h=MAX;}}
        canvas.width=w;canvas.height=h;
        canvas.getContext("2d").drawImage(img,0,0,w,h);
        const dataUrl=canvas.toDataURL("image/jpeg",0.8);
        setPreviewPic(dataUrl);setForm(prev=>({...prev,profilePic:dataUrl}));
      };
      img.src=reader.result;
    };
    reader.readAsDataURL(file);
  };
  const removeProfilePic=()=>{setPreviewPic(null);setForm(prev=>({...prev,profilePic:""}));if(fileInputRef.current)fileInputRef.current.value="";};
  const save=async()=>{setProfile(form);try{await fbSetProfile(user.uid,form);}catch(e){console.error(e);}setEditing(false);};
  const cancel=()=>{setEditing(false);setForm(profile);setPreviewPic(profile.profilePic||null);};
  const inp={padding:"10px 13px",borderRadius:8,border:`1.5px solid ${C.border}`,fontSize:14,color:C.textPrimary,outline:"none",boxSizing:"border-box",width:"100%"};
  const displayPic=profile.profilePic||null;
  return <div style={{animation:"fadeSlideIn 0.35s ease"}}>
    <div style={{background:C.white,borderRadius:20,border:`1px solid ${C.borderLight}`,padding:isMobile?20:32,boxShadow:`0 2px 12px ${C.shadow}`,marginBottom:20,display:"flex",alignItems:"center",gap:isMobile?16:24,flexWrap:isMobile?"wrap":"nowrap"}}>
      {editing?(
        <div style={{display:"flex",flexDirection:"column",alignItems:"center",gap:7,flexShrink:0}}>
          <div style={{position:"relative",cursor:"pointer"}} onClick={()=>fileInputRef.current&&fileInputRef.current.click()}>
            <Avatar name={form.name||user.displayName} size={72} profilePic={previewPic}/>
            <div style={{position:"absolute",bottom:-2,right:-2,width:24,height:24,borderRadius:"50%",background:`linear-gradient(135deg,${C.greenAccent},${C.greenDark})`,display:"flex",alignItems:"center",justifyContent:"center",color:"#fff",border:`2px solid ${C.white}`}}><I.Camera/></div>
          </div>
          <input ref={fileInputRef} type="file" accept="image/*" onChange={handleImageUpload} style={{display:"none"}}/>
          <div style={{display:"flex",gap:4}}>
            <button onClick={()=>fileInputRef.current&&fileInputRef.current.click()} style={{padding:"3px 8px",borderRadius:6,border:`1px solid ${C.border}`,background:"transparent",color:C.textSecondary,fontSize:11,cursor:"pointer"}}>Upload</button>
            {previewPic&&<button onClick={removeProfilePic} style={{padding:"3px 8px",borderRadius:6,border:`1px solid ${C.border}`,background:"transparent",color:C.red,fontSize:11,cursor:"pointer"}}>Remove</button>}
          </div>
        </div>
      ):(
        <Avatar name={profile.name||user.displayName} size={72} photoURL={!displayPic?user.photoURL:undefined} profilePic={displayPic}/>
      )}
      <div style={{flex:1,minWidth:isMobile?"100%":"200px"}}>
        {editing?(
          <div style={{display:"flex",flexDirection:"column",gap:10}}>
            <div style={{display:"grid",gridTemplateColumns:isMobile?"1fr 70px":"1fr 70px 1fr",gap:9}}>
              <input style={inp} placeholder="Name" value={form.name} onChange={e=>setForm({...form,name:e.target.value})}/>
              <input style={inp} placeholder="Age" type="number" value={form.age} onChange={e=>setForm({...form,age:e.target.value})}/>
              {!isMobile&&<input style={inp} placeholder="Location" value={form.location} onChange={e=>setForm({...form,location:e.target.value})}/>}
            </div>
            {isMobile&&<input style={inp} placeholder="Location" value={form.location} onChange={e=>setForm({...form,location:e.target.value})}/>}
            <div style={{position:"relative"}}>
              <input style={{...inp,paddingLeft:34}} placeholder="School (optional)" value={form.school||""} onChange={e=>setForm({...form,school:e.target.value})}/>
              <div style={{position:"absolute",left:11,top:"50%",transform:"translateY(-50%)",color:C.textMuted,display:"flex"}}><I.School/></div>
            </div>
            <div style={{display:"flex",gap:7,alignItems:"center",flexWrap:"wrap"}}>
              <button onClick={save} style={{padding:"8px 18px",borderRadius:8,border:"none",background:C.greenAccent,color:"#fff",fontWeight:600,fontSize:13,cursor:"pointer"}}>Save</button>
              <button onClick={cancel} style={{padding:"8px 18px",borderRadius:8,border:`1px solid ${C.border}`,background:"transparent",color:C.textSecondary,fontWeight:600,fontSize:13,cursor:"pointer"}}>Cancel</button>
              {form.school&&<button onClick={()=>setForm({...form,school:""})} style={{padding:"8px 14px",borderRadius:8,border:`1px solid ${C.border}`,background:"transparent",color:C.red,fontWeight:600,fontSize:12,cursor:"pointer"}}>Leave School</button>}
            </div>
          </div>
        ):(
          <>
            <h1 style={{fontFamily:"'Fraunces',serif",fontWeight:800,fontSize:"clamp(20px,5vw,26px)",color:C.textPrimary,margin:"0 0 4px 0",letterSpacing:"-0.02em"}}>{profile.name||user.displayName}</h1>
            <div style={{display:"flex",gap:14,flexWrap:"wrap",marginBottom:8}}>
              {profile.age&&<span style={{fontSize:13,color:C.textMuted,display:"flex",alignItems:"center",gap:4}}><I.User/>Age {profile.age}</span>}
              {profile.location&&<span style={{fontSize:13,color:C.textMuted,display:"flex",alignItems:"center",gap:4}}><I.MapPin/>{profile.location}</span>}
              {profile.school&&<span style={{fontSize:13,color:C.greenDark,display:"flex",alignItems:"center",gap:4,fontWeight:500}}><I.School/>{profile.school}</span>}
              {!isMobile&&<span style={{fontSize:13,color:C.textMuted,display:"flex",alignItems:"center",gap:4}}><I.Mail/>{user.email}</span>}
            </div>
            <button onClick={()=>setEditing(true)} style={{padding:"6px 14px",borderRadius:8,border:`1px solid ${C.border}`,background:"transparent",color:C.textSecondary,fontWeight:600,fontSize:12,cursor:"pointer"}}>Edit Profile</button>
          </>
        )}
      </div>
    </div>
    <div style={{display:"grid",gridTemplateColumns:"repeat(3,1fr)",gap:12,marginBottom:20}}>
      {[{label:"Hours Served",value:profile.hoursServed||0,icon:<I.Clock/>,accent:C.greenAccent},{label:"Events Joined",value:signedUp.length,icon:<I.Calendar/>,accent:"#4CAF50"},{label:"Board Rank",value:rank>0?`#${rank}`:"‚Äî",icon:<I.Trophy/>,accent:"#FF9800"}].map(s=>(
        <div key={s.label} style={{background:C.white,borderRadius:14,border:`1px solid ${C.borderLight}`,padding:isMobile?"16px 10px":"20px 16px",textAlign:"center",boxShadow:`0 1px 3px ${C.shadow}`}}>
          <div style={{display:"flex",justifyContent:"center",marginBottom:6,color:s.accent}}>{s.icon}</div>
          <div style={{fontSize:isMobile?22:28,fontWeight:800,color:s.accent,lineHeight:1,marginBottom:3}}>{s.value}</div>
          <div style={{fontSize:isMobile?10:12,color:C.textMuted,fontWeight:500,lineHeight:1.3}}>{s.label}</div>
        </div>
      ))}
    </div>
    <h2 style={{fontFamily:"'Fraunces',serif",fontWeight:700,fontSize:18,color:C.textPrimary,margin:"0 0 14px 0"}}>Registered Events</h2>
    {signedUp.length===0
      ?<p style={{fontSize:14,color:C.textMuted}}>No upcoming events registered.</p>
      :<div style={{display:"flex",flexDirection:"column",gap:10}}>
        {signedUp.map(l=>(
          <div key={l.id} onClick={()=>onView(l.id)}
            style={{background:C.white,borderRadius:12,border:`1px solid ${C.borderLight}`,padding:"14px 18px",display:"flex",alignItems:"center",justifyContent:"space-between",cursor:"pointer",transition:"all 0.2s",gap:10}}
            onMouseEnter={e=>{e.currentTarget.style.boxShadow=`0 4px 16px ${C.shadowMd}`;e.currentTarget.style.borderColor=C.greenMid;}}
            onMouseLeave={e=>{e.currentTarget.style.boxShadow="none";e.currentTarget.style.borderColor=C.borderLight;}}>
            <div style={{minWidth:0}}>
              <h4 style={{fontFamily:"'Fraunces',serif",fontWeight:700,fontSize:15,color:C.textPrimary,margin:"0 0 3px 0"}}>{l.title}</h4>
              <span style={{fontSize:12,color:C.textMuted}}>{formatDate(l.date)} ¬∑ {l.time}</span>
            </div>
            <div style={{background:C.greenLight,color:C.greenDark,borderRadius:7,padding:"3px 9px",fontSize:11,fontWeight:700,flexShrink:0}}>Confirmed</div>
          </div>
        ))}
      </div>
    }
  </div>;
}

function ViewProfileModal({uid,leaderboard,onClose}){
  const [profileData,setProfileData]=useState(null);
  const [loadingP,setLoadingP]=useState(true);
  useEffect(()=>{
    let cancelled=false;
    (async()=>{setLoadingP(true);try{const p=await fbGetProfile(uid);if(!cancelled)setProfileData(p);}catch(e){}if(!cancelled)setLoadingP(false);})();
    return()=>{cancelled=true;};
  },[uid]);
  const rank=leaderboard.findIndex(p=>p.uid===uid)+1;
  return <div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.5)",zIndex:500,display:"flex",alignItems:"center",justifyContent:"center",padding:20}} onClick={onClose}>
    <div onClick={e=>e.stopPropagation()} style={{background:C.white,borderRadius:22,border:`1px solid ${C.borderLight}`,padding:"32px 28px",maxWidth:400,width:"100%",boxShadow:"0 20px 60px rgba(0,0,0,0.2)",position:"relative"}}>
      <button onClick={onClose} style={{position:"absolute",top:14,right:14,background:"none",border:"none",cursor:"pointer",color:C.textMuted,padding:4}}><I.X/></button>
      {loadingP?<div style={{padding:"36px 0",textAlign:"center",color:C.textMuted,fontSize:14}}>Loading...</div>
      :profileData?(
        <div style={{textAlign:"center"}}>
          <div style={{display:"flex",justifyContent:"center",marginBottom:12}}><Avatar name={profileData.name} size={68} profilePic={profileData.profilePic}/></div>
          <h2 style={{fontFamily:"'Fraunces',serif",fontWeight:800,fontSize:22,color:C.textPrimary,margin:"0 0 6px 0"}}>{profileData.name||"Anonymous"}</h2>
          <div style={{display:"flex",justifyContent:"center",gap:12,flexWrap:"wrap",marginBottom:16}}>
            {profileData.age&&<span style={{fontSize:13,color:C.textMuted,display:"flex",alignItems:"center",gap:4}}><I.User/>Age {profileData.age}</span>}
            {profileData.location&&<span style={{fontSize:13,color:C.textMuted,display:"flex",alignItems:"center",gap:4}}><I.MapPin/>{profileData.location}</span>}
            {profileData.school&&<span style={{fontSize:13,color:C.greenDark,display:"flex",alignItems:"center",gap:4,fontWeight:500}}><I.School/>{profileData.school}</span>}
          </div>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10}}>
            <div style={{background:C.cream,borderRadius:12,padding:"14px 10px"}}>
              <div style={{fontSize:22,fontWeight:800,color:C.greenAccent,lineHeight:1}}>{profileData.hoursServed||0}</div>
              <div style={{fontSize:12,color:C.textMuted,marginTop:3}}>Hours Served</div>
            </div>
            <div style={{background:C.cream,borderRadius:12,padding:"14px 10px"}}>
              <div style={{fontSize:22,fontWeight:800,color:"#FF9800",lineHeight:1}}>{rank>0?`#${rank}`:"‚Äî"}</div>
              <div style={{fontSize:12,color:C.textMuted,marginTop:3}}>Leaderboard Rank</div>
            </div>
          </div>
        </div>
      ):<div style={{padding:"36px 0",textAlign:"center",color:C.textMuted,fontSize:14}}>Profile not found.</div>}
    </div>
  </div>;
}

// ============================================================
// APP
// ============================================================
function App(){
  const isMobile=useIsMobile();
  const [user,setUser]=useState(null);
  const [profile,setProfile]=useState({name:"",age:"",location:"",hoursServed:0,profilePic:"",school:""});
  const [listings,setListings]=useState([]);
  const [leaderboard,setLeaderboard]=useState([]);
  const [page,setPage]=useState("events");
  const [toast,setToast]=useState(null);
  const [loading,setLoading]=useState(true);
  const [refreshing,setRefreshing]=useState(false);
  const [deleteTgt,setDeleteTgt]=useState(null);
  const [showLoginModal,setShowLoginModal]=useState(false);
  const [loginLoading,setLoginLoading]=useState(false);
  const [loginError,setLoginError]=useState(null);
  const [viewProfileUid,setViewProfileUid]=useState(null);
  const [selEvent,setSelEvent]=useState(null);

  const viewEvent=(id)=>{setSelEvent(id);setPage("events");};
  const toast_=(msg)=>{setToast(msg);setTimeout(()=>setToast(null),3000);};
  const loadL=async()=>{const l=await fbGetListings();setListings(l);};
  const loadLb=async()=>{try{const lb=await fbGetLeaderboard();setLeaderboard(lb);}catch(e){console.error(e);}};
  const refresh=async()=>{setRefreshing(true);try{await Promise.all([loadL(),loadLb()]);}catch(e){console.error(e);}setRefreshing(false);};
  const requireLogin=()=>{setShowLoginModal(true);};

  const nav=(p)=>{
    if(!user&&(p==="upcoming"||p==="my-listings"||p==="create"||p==="profile")){
      setShowLoginModal(true);return;
    }
    setPage(p);
    if(p==="events"||p==="leaderboard")refresh();
  };

  const handleViewProfile=(uid)=>{
    if(user&&uid===user.uid){setPage("profile");}else{setViewProfileUid(uid);}
  };

  const doLogin=async()=>{
    setLoginLoading(true);setLoginError(null);
    try{await fbSignIn();setShowLoginModal(false);}
    catch(e){setLoginError(e.message||"Sign-in failed.");}
    setLoginLoading(false);
  };

  useEffect(()=>{
    let unsub;
    (async()=>{
      const fb=await loadFirebase();
      unsub=fb.onAuthStateChanged(fb.auth,async u=>{
        if(u){
          setUser({uid:u.uid,displayName:u.displayName,email:u.email,photoURL:u.photoURL});
          const p=await fbGetProfile(u.uid);
          if(p){if(!p.email||p.email!==u.email){await fbSetProfile(u.uid,{email:u.email});p.email=u.email;}setProfile(p);}
          else{const np={name:u.displayName||"",age:"",location:"",hoursServed:0,profilePic:"",email:u.email||"",school:""};await fbSetProfile(u.uid,np);setProfile(np);}
        }else{setUser(null);}
        try{await Promise.all([loadL(),loadLb()]);}catch(e){console.error(e);}
        setLoading(false);
      });
    })();
    return()=>{if(unsub)unsub();};
  },[]);

  const logout=async()=>{try{await fbSignOut();}catch(e){console.error(e);}setUser(null);setProfile({name:"",age:"",location:"",hoursServed:0,profilePic:"",school:""});setPage("events");};

  const signUp=async(id)=>{
    if(!user){requireLogin();return;}
    const l=listings.find(x=>x.id===id);if(!l)return;
    const h=parseHours(l.time);
    setListings(p=>p.map(x=>x.id===id?{...x,currentVolunteers:x.currentVolunteers+1,volunteers:[...(x.volunteers||[]),user.uid]}:x));
    setProfile(p=>({...p,hoursServed:(p.hoursServed||0)+h}));
    toast_(`Signed up for ${l.title}! +${h} hr${h!==1?"s":""}`);
    try{await fbSignUp(id,user.uid,h);await loadLb();}
    catch(e){console.error(e);setListings(p=>p.map(x=>x.id===id?{...x,currentVolunteers:x.currentVolunteers-1,volunteers:(x.volunteers||[]).filter(v=>v!==user.uid)}:x));setProfile(p=>({...p,hoursServed:Math.max(0,(p.hoursServed||0)-h)}));toast_("Error signing up.");}
  };

  const unsign=async(id)=>{
    if(!user)return;
    const l=listings.find(x=>x.id===id);if(!l)return;
    const h=parseHours(l.time);
    setListings(p=>p.map(x=>x.id===id?{...x,currentVolunteers:Math.max(0,x.currentVolunteers-1),volunteers:(x.volunteers||[]).filter(v=>v!==user.uid)}:x));
    setProfile(p=>({...p,hoursServed:Math.max(0,(p.hoursServed||0)-h)}));
    toast_(`Cancelled registration for ${l.title}`);
    try{await fbUnsign(id,user.uid,h);await loadLb();}
    catch(e){console.error(e);setListings(p=>p.map(x=>x.id===id?{...x,currentVolunteers:x.currentVolunteers+1,volunteers:[...(x.volunteers||[]),user.uid]}:x));setProfile(p=>({...p,hoursServed:(p.hoursServed||0)+h}));toast_("Error cancelling.");}
  };

  const confirmDelete=async()=>{
    if(!deleteTgt)return;
    const{id,title}=deleteTgt;
    const listing=listings.find(l=>l.id===id);
    setDeleteTgt(null);
    setListings(p=>p.filter(l=>l.id!==id));
    toast_(`"${title}" deleted.`);
    try{
      if(listing&&listing.volunteers&&listing.volunteers.length>0){
        const hours=parseHours(listing.time);
        await fbDeductHoursFromUsers(listing.volunteers,hours);
      }
      await fbDeleteListing(id);
      await Promise.all([loadL(),loadLb()]);
    }catch(e){console.error(e);toast_("Error deleting.");await loadL();}
  };

  const createListing=async(data)=>{
    try{const newId=await fbAddListing(data);setListings(p=>[...p,{...data,id:newId}].sort((a,b)=>a.date.localeCompare(b.date)));nav("my-listings");}
    catch(e){console.error(e);}
  };

  if(loading)return <div style={{minHeight:"100vh",display:"flex",alignItems:"center",justifyContent:"center",background:C.offWhite}}><p style={{color:C.textMuted,fontSize:15}}>Loading‚Ä¶</p></div>;

  const LoginModal=()=>(
    <div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.5)",zIndex:500,display:"flex",alignItems:"center",justifyContent:"center",padding:20}} onClick={()=>setShowLoginModal(false)}>
      <div onClick={e=>e.stopPropagation()} style={{background:C.white,borderRadius:22,border:`1px solid ${C.borderLight}`,padding:"36px 28px",maxWidth:400,width:"100%",textAlign:"center",boxShadow:"0 20px 60px rgba(0,0,0,0.2)",position:"relative"}}>
        <button onClick={()=>setShowLoginModal(false)} style={{position:"absolute",top:14,right:14,background:"none",border:"none",cursor:"pointer",color:C.textMuted,padding:4}}><I.X/></button>
        <div style={{display:"flex",alignItems:"center",justifyContent:"center",gap:9,marginBottom:7}}>
          <div style={{width:36,height:36,borderRadius:10,overflow:"hidden"}}><img src="voluntir.png" alt="" style={{width:36,height:36,objectFit:"cover"}} onError={e=>e.target.style.display='none'}/></div>
          <span style={{fontFamily:"'Fraunces',serif",fontWeight:800,fontSize:22,color:C.textPrimary,letterSpacing:"-0.02em"}}>Voluntir</span>
        </div>
        <p style={{fontSize:14,color:C.textSecondary,marginBottom:24,lineHeight:1.6}}>Sign in to sign up for events, create listings, and track your volunteer hours.</p>
        {loginError&&<div style={{background:C.redLight,color:C.red,borderRadius:10,padding:"10px 14px",fontSize:13,marginBottom:14,textAlign:"left"}}>{loginError}</div>}
        <button onClick={doLogin} disabled={loginLoading}
          style={{width:"100%",padding:"13px 20px",borderRadius:12,border:`1.5px solid ${C.border}`,background:C.white,fontWeight:600,fontSize:15,color:C.textPrimary,cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",gap:10}}
          onMouseEnter={e=>e.currentTarget.style.borderColor=C.greenAccent}
          onMouseLeave={e=>e.currentTarget.style.borderColor=C.border}>
          <I.Google/>{loginLoading?"Signing in...":"Continue with Google"}
        </button>
      </div>
    </div>
  );

  const mainPadding=isMobile?"16px 14px 80px":"32px 24px 80px";

  return <>
    <style>{`
      *{margin:0;padding:0;box-sizing:border-box;}
      body{font-family:'Asap',sans-serif;background:${C.offWhite};color:${C.textPrimary};-webkit-font-smoothing:antialiased;}
      @keyframes fadeSlideIn{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
      @keyframes toastIn{from{opacity:0;transform:translateY(16px) scale(0.96)}to{opacity:1;transform:translateY(0) scale(1)}}
      @keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
      select option{font-family:'Asap',sans-serif;}
      input[type="date"]::-webkit-calendar-picker-indicator{cursor:pointer;opacity:0.6;}
      @media(max-width:768px){
        .events-grid{grid-template-columns:1fr !important;}
      }
      @media(max-width:480px){
        .events-grid{grid-template-columns:1fr !important;}
      }
    `}</style>
    <div style={{minHeight:"100vh",background:C.offWhite}}>
      <Navbar currentPage={page} setCurrentPage={nav} onLogout={logout} onLogin={()=>setShowLoginModal(true)} user={user} isMobile={isMobile}/>
      <main style={{maxWidth:1200,margin:"0 auto",padding:mainPadding}}>
        {page==="events"      &&<EventsPage listings={listings} user={user} onSignUp={signUp} onUnsign={unsign} onDelete={setDeleteTgt} onRefresh={refresh} refreshing={refreshing} initialSel={selEvent} key={selEvent} onRequireLogin={requireLogin} isMobile={isMobile}/>}
        {page==="upcoming"    &&user&&<UpcomingPage listings={listings} user={user} onUnsign={unsign} onView={viewEvent}/>}
        {page==="my-listings" &&user&&<MyListingsPage listings={listings} user={user} onDelete={setDeleteTgt} onView={viewEvent}/>}
        {page==="leaderboard" &&<LeaderboardPage leaderboard={leaderboard} user={user||{uid:null}} onViewProfile={handleViewProfile} isMobile={isMobile}/>}
        {page==="create"      &&user&&<CreateListingPage user={user} onCreateListing={createListing} isMobile={isMobile}/>}
        {page==="profile"     &&user&&<ProfilePage user={user} profile={profile} setProfile={setProfile} listings={listings} leaderboard={leaderboard} onView={viewEvent} isMobile={isMobile}/>}
      </main>
      {toast&&<div style={{position:"fixed",bottom:isMobile?72:24,left:"50%",transform:"translateX(-50%)",background:C.greenDark,color:"#fff",padding:"11px 20px",borderRadius:12,fontSize:14,fontWeight:600,boxShadow:"0 8px 32px rgba(0,0,0,0.18)",display:"flex",alignItems:"center",gap:7,animation:"toastIn 0.3s ease",zIndex:200,whiteSpace:"nowrap"}}><span style={{color:C.greenMid}}><I.Check/></span>{toast}</div>}
      {deleteTgt&&<ConfirmModal title="Delete this listing?" message={`"${deleteTgt.title}" will be permanently removed and all sign-ups will be lost.`} onConfirm={confirmDelete} onCancel={()=>setDeleteTgt(null)}/>}
      {showLoginModal&&<LoginModal/>}
      {viewProfileUid&&<ViewProfileModal uid={viewProfileUid} leaderboard={leaderboard} onClose={()=>setViewProfileUid(null)}/>}
    </div>
  </>;
}

const root=ReactDOM.createRoot(document.getElementById("root"));
root.render(<App/>);
setTimeout(()=>{const ls=document.getElementById("loading-screen");if(ls){ls.classList.add("fade-out");setTimeout(()=>ls.remove(),300);}},100);
  </script>
</body>
</html>